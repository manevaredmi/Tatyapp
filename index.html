<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taty Ultra Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #4e73df; --success: #1cc88a; --danger: #e74a3b;
            --warning: #f6c23e; --info: #36b9cc; --dark: #5a5c69; --bg: #f8f9fc; --pix: #25D366;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--dark); }
        .container { max-width: 500px; margin: auto; display: none; }
        
        #alerta-vencido { display: none; background: var(--danger); color: white; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        .dash { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .dash-card { background: white; padding: 12px; border-radius: 10px; text-align: center; border-bottom: 4px solid var(--primary); }

        #search-box { width: 100%; padding: 15px; margin-bottom: 15px; border: 3px solid var(--primary); border-radius: 12px; box-sizing: border-box; font-size: 16px; outline: none; }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; background: #eaecf4; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        form, .card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e3e6f0; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #d1d3e2; border-radius: 8px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer; margin-bottom: 8px; }
        .btn-add { background: var(--primary); }
        .btn-update { background: var(--warning); color: #222; }
        
        .lista { list-style: none; padding: 0; }
        .item { background: #fff; margin-bottom: 10px; padding: 15px; border-radius: 10px; border-left: 6px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .vencido { border-left-color: var(--danger) !important; background: #fff5f5; }
        
        .acoes { display: flex; gap: 6px; margin-top: 12px; }
        .btn-mini { flex: 1; padding: 10px; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div id="login-box" style="text-align: center; margin-top: 100px;">
    <h2>üîê Acesso Restrito</h2>
    <input type="password" id="pass" placeholder="Digite a Senha" style="width: 200px;">
    <button class="btn btn-add" style="width: 200px;" onclick="checkPass()">Entrar</button>
</div>

<div class="container" id="app">
    <h2 style="text-align:center; color: var(--primary);">üöÄ Taty Ultra Pro</h2>
    <div id="alerta-vencido">‚ö†Ô∏è EXISTEM CONTAS VENCIDAS!</div>

    <div class="dash">
        <div class="dash-card"><h6>Receber</h6><div id="dash-receber" style="color:var(--success)">R$ 0,00</div></div>
        <div class="dash-card"><h6>Contas</h6><div id="dash-contas" style="color:var(--danger)">R$ 0,00</div></div>
        <div class="dash-card"><h6>Saldo</h6><div id="dash-lucro" style="color:var(--primary)">R$ 0,00</div></div>
    </div>

    <input type="text" id="search-box" placeholder="üîç Pesquisar..." onkeyup="render()">

    <div class="tabs">
        <button class="tab-btn active" id="btn-tab-vendas" onclick="switchTab(event, 'vendas')">Vendas</button>
        <button class="tab-btn" id="btn-tab-contas" onclick="switchTab(event, 'contas')">Contas</button>
        <button class="tab-btn" id="btn-tab-agenda" onclick="switchTab(event, 'agenda')">Agenda</button>
        <button class="tab-btn" onclick="switchTab(event, 'config')">‚öôÔ∏è</button>
    </div>

    <div id="sec-vendas" class="section active">
        <form id="f-vendas" onsubmit="handleVenda(event)">
            <input type="hidden" id="v-id">
            <input type="text" id="v-cliente" placeholder="Nome do Cliente" required>
            <input type="text" id="v-zap" placeholder="WhatsApp" required>
            <input type="text" id="v-prod" placeholder="Produto" required>
            <input type="number" step="0.01" id="v-valor" placeholder="Valor" required>
            <input type="date" id="v-data" required>
            <textarea id="v-msg" rows="2" placeholder="Mensagem"></textarea>
            <button type="submit" id="btn-v-main" class="btn btn-add">Salvar Venda</button>
            <button type="button" class="btn" style="background:#ddd; color:#333" onclick="resetVenda()">Limpar</button>
        </form>
        <ul id="listaVendas" class="lista"></ul>
        <h4 style="color: var(--success)">‚úÖ Pagos</h4>
        <ul id="listaVendasPagas" class="lista"></ul>
    </div>

    <div id="sec-contas" class="section">
        <form id="f-contas" onsubmit="handleConta(event)">
            <input type="hidden" id="c-id">
            <input type="text" id="c-nome" placeholder="Nome da Conta" required>
            <input type="number" step="0.01" id="c-valor" placeholder="Valor" required>
            <input type="date" id="c-data" required>
            <button type="submit" id="btn-c-main" class="btn btn-add">Salvar Conta</button>
            <button type="button" class="btn" style="background:#ddd; color:#333" onclick="resetConta()">Limpar</button>
        </form>
        <ul id="listaContas" class="lista"></ul>
    </div>

    <div id="sec-agenda" class="section">
        <form id="f-agenda" onsubmit="handleAgenda(event)">
            <input type="hidden" id="a-id">
            <input type="text" id="a-task" placeholder="Compromisso" required>
            <select id="a-prio">
                <option value="URGENTE">üî¥ Urgente</option>
                <option value="ROTINA" selected>üîµ Rotina</option>
            </select>
            <input type="date" id="a-data" required>
            <button type="submit" id="btn-a-main" class="btn btn-add">Agendar</button>
            <button type="button" class="btn" style="background:#ddd; color:#333" onclick="resetAgenda()">Limpar</button>
        </form>
        <ul id="listaAgenda" class="lista"></ul>
    </div>

    <div id="sec-config" class="section">
        <div class="card">
            <h4>‚öôÔ∏è Configura√ß√µes</h4>
            <input type="text" id="cfg-pix" placeholder="Chave Pix">
            <button class="btn" style="background:var(--success)" onclick="savePix()">Salvar Pix</button>
            <button class="btn" style="background:var(--info)" onclick="exportPDF()">PDF</button>
        </div>
    </div>
</div>

<script>
    const PASS_CORRECT = "551506";
    let dbV = JSON.parse(localStorage.getItem('dbV')) || [];
    let dbC = JSON.parse(localStorage.getItem('dbC')) || [];
    let dbA = JSON.parse(localStorage.getItem('dbA')) || [];
    let pix = localStorage.getItem('dbPix') || "";

    function checkPass() {
        if(document.getElementById('pass').value === PASS_CORRECT) {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            render();
        } else { alert("Senha Incorreta!"); }
    }

    function switchTab(e, tab) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-' + tab).classList.add('active');
        if(e) e.target.classList.add('active');
    }

    // --- FUN√á√ïES DE AGENDA (CORRIGIDAS) ---
    function handleAgenda(e) {
        e.preventDefault();
        const id = document.getElementById('a-id').value;
        const a = { 
            id: id ? parseInt(id) : Date.now(), 
            t: document.getElementById('a-task').value, 
            p: document.getElementById('a-prio').value, 
            d: document.getElementById('a-data').value 
        };
        if(id) dbA = dbA.map(x => x.id == id ? a : x); else dbA.push(a);
        resetAgenda(); 
        render();
    }

    function resetAgenda() {
        document.getElementById('f-agenda').reset();
        document.getElementById('a-id').value = "";
        document.getElementById('btn-a-main').innerText = "Agendar";
        document.getElementById('btn-a-main').className = "btn btn-add";
    }

    function editAgenda(id) {
        const a = dbA.find(x => x.id == id);
        document.getElementById('a-id').value = a.id;
        document.getElementById('a-task').value = a.t;
        document.getElementById('a-prio').value = a.p;
        document.getElementById('a-data').value = a.d;
        document.getElementById('btn-a-main').innerText = "ATUALIZAR";
        document.getElementById('btn-a-main').className = "btn btn-update";
        switchTab(null, 'agenda');
        document.getElementById('btn-tab-agenda').classList.add('active');
        window.scrollTo(0,0);
    }

    // --- RESTANTE DAS FUN√á√ïES ---
    function handleVenda(e) {
        e.preventDefault();
        const id = document.getElementById('v-id').value;
        const v = { id: id ? parseInt(id) : Date.now(), cli: document.getElementById('v-cliente').value, zap: document.getElementById('v-zap').value, prod: document.getElementById('v-prod').value, val: parseFloat(document.getElementById('v-valor').value), data: document.getElementById('v-data').value, msg: document.getElementById('v-msg').value, pago: id ? dbV.find(x => x.id == id).pago : false };
        if(id) dbV = dbV.map(x => x.id == id ? v : x); else dbV.push(v);
        resetVenda(); render();
    }
    function resetVenda() { document.getElementById('f-vendas').reset(); document.getElementById('v-id').value = ""; document.getElementById('btn-v-main').innerText = "Salvar Venda"; document.getElementById('btn-v-main').className = "btn btn-add"; }
    function editVenda(id) {
        const v = dbV.find(x => x.id == id);
        document.getElementById('v-id').value = v.id; document.getElementById('v-cliente').value = v.cli; document.getElementById('v-zap').value = v.zap; document.getElementById('v-prod').value = v.prod; document.getElementById('v-valor').value = v.val; document.getElementById('v-data').value = v.data; document.getElementById('v-msg').value = v.msg;
        document.getElementById('btn-v-main').innerText = "ATUALIZAR"; document.getElementById('btn-v-main').className = "btn btn-update";
        switchTab(null, 'vendas'); document.getElementById('btn-tab-vendas').classList.add('active'); window.scrollTo(0,0);
    }

    function handleConta(e) {
        e.preventDefault();
        const id = document.getElementById('c-id').value;
        const c = { id: id ? parseInt(id) : Date.now(), n: document.getElementById('c-nome').value, v: parseFloat(document.getElementById('c-valor').value), d: document.getElementById('c-data').value };
        if(id) dbC = dbC.map(x => x.id == id ? c : x); else dbC.push(c);
        resetConta(); render();
    }
    function resetConta() { document.getElementById('f-contas').reset(); document.getElementById('c-id').value = ""; document.getElementById('btn-c-main').innerText = "Salvar Conta"; document.getElementById('btn-c-main').className = "btn btn-add"; }
    function editConta(id) {
        const c = dbC.find(x => x.id == id);
        document.getElementById('c-id').value = c.id; document.getElementById('c-nome').value = c.n; document.getElementById('c-valor').value = c.v; document.getElementById('c-data').value = c.d;
        document.getElementById('btn-c-main').innerText = "ATUALIZAR"; document.getElementById('btn-c-main').className = "btn btn-update";
        switchTab(null, 'contas'); document.getElementById('btn-tab-contas').classList.add('active');
    }

    function savePix() { pix = document.getElementById('cfg-pix').value; localStorage.setItem('dbPix', pix); alert("Pix Salvo!"); }
    function exportPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("Relat√≥rio Financeiro", 10, 10); doc.save("TatyFinanceiro.pdf"); }

    function render() {
        localStorage.setItem('dbV', JSON.stringify(dbV));
        localStorage.setItem('dbC', JSON.stringify(dbC));
        localStorage.setItem('dbA', JSON.stringify(dbA));

        const query = document.getElementById('search-box').value.toLowerCase();
        const hoje = new Date().toISOString().split('T')[0];
        let alertar = false;

        const rec = dbV.filter(v=>!v.pago).reduce((s,v)=>s+v.val, 0);
        const con = dbC.reduce((s,c)=>s+c.v, 0);
        document.getElementById('dash-receber').innerText = `R$ ${rec.toFixed(2)}`;
        document.getElementById('dash-contas').innerText = `R$ ${con.toFixed(2)}`;
        document.getElementById('dash-lucro').innerText = `R$ ${(rec-con).toFixed(2)}`;

        const lv = document.getElementById('listaVendas'); const lvp = document.getElementById('listaVendasPagas');
        const lc = document.getElementById('listaContas'); const la = document.getElementById('listaAgenda');
        lv.innerHTML = ''; lvp.innerHTML = ''; lc.innerHTML = ''; la.innerHTML = '';

        dbV.forEach(v => {
            if(v.cli.toLowerCase().includes(query)) {
                if(v.data < hoje && !v.pago) alertar = true;
                const zap = `https://wa.me/${v.zap}?text=${encodeURIComponent(v.msg + "\nPix: " + pix)}`;
                const item = `<li class="item"><b>${v.cli}</b> - R$ ${v.val.toFixed(2)}<div class="acoes"><button class="btn-mini" style="background:var(--success)" onclick="dbV=dbV.map(x=>x.id==${v.id}?{...x,pago:!x.pago}:x);render()">OK</button><button class="btn-mini" style="background:var(--info)" onclick="editVenda(${v.id})">‚úèÔ∏è</button><a href="${zap}" target="_blank" class="btn-mini" style="background:var(--pix);text-decoration:none">ZAP</a><button class="btn-mini" style="background:var(--danger)" onclick="dbV=dbV.filter(x=>x.id!=${v.id});render()">‚úñ</button></div></li>`;
                if(v.pago) lvp.innerHTML += item; else lv.innerHTML += item;
            }
        });

        dbC.forEach(c => {
            if(c.n.toLowerCase().includes(query)) {
                if(c.d < hoje) alertar = true;
                lc.innerHTML += `<li class="item"><b>${c.n}</b> - R$ ${c.v.toFixed(2)}<div class="acoes"><button class="btn-mini" style="background:var(--info)" onclick="editConta(${c.id})">‚úèÔ∏è</button><button class="btn-mini" style="background:var(--danger)" onclick="dbC=dbC.filter(x=>x.id!=${c.id});render()">‚úñ</button></div></li>`;
            }
        });

        dbA.forEach(a => {
            if(a.t.toLowerCase().includes(query)) {
                la.innerHTML += `<li class="item"><b>${a.t}</b> - ${a.d}<br><small>${a.p}</small><div class="acoes"><button class="btn-mini" style="background:var(--info)" onclick="editAgenda(${a.id})">‚úèÔ∏è</button><button class="btn-mini" style="background:var(--danger)" onclick="dbA=dbA.filter(x=>x.id!=${a.id});render()">‚úñ</button></div></li>`;
            }
        });

        document.getElementById('alerta-vencido').style.display = alertar ? 'block' : 'none';
    }
</script>
</body>
</html>
